<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sponsor Dashboard</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=IBM+Plex+Mono:wght@400;500;600&display=swap"
    rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #06090F;
      color: #E2E8F0;
      font-family: 'Outfit', sans-serif;
      min-height: 100vh;
    }

    input:focus {
      border-color: #4F8FF7 !important;
      outline: none;
    }

    ::placeholder {
      color: #4A5A72;
    }

    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0C1018;
    }

    ::-webkit-scrollbar-thumb {
      background: #1B2233;
      border-radius: 3px;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fade-in {
      animation: fadeIn 0.3s ease;
    }

    a {
      color: inherit;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    const KEYS = { config: "bh-config", sponsors: "bh-sponsors", runs: "bh-runs", contracts: "bh-contracts" };
    const store = {
      get(k) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : null; } catch { return null; } },
      set(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { console.error(e); } },
    };

    const uid = () => Math.random().toString(36).slice(2, 10);
    const num = (n) => (n || 0).toLocaleString();
    const pct = (n) => (n || 0).toFixed(2) + "%";
    const fmtDate = (d) => { if (!d) return "â€”"; return new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }); };
    const tsToDate = (ts) => { if (!ts) return null; return new Date(ts * 1000).toISOString().split("T")[0]; };
    const money = (n) => "$" + (n || 0).toFixed(2);
    const getTerms = (ct) => { const t = []; if (ct.exclusivePlacement) t.push("Exclusive Placement"); if (ct.primaryPlacement) t.push("Primary Placement"); if (ct.categoryExclusivity) t.push("Category Exclusivity"); if (ct.pricingNotes?.trim()) t.push(ct.pricingNotes.trim()); return t; };
    const getRunClicks = (r) => r.useVerified ? (r.verifiedClicks || 0) : (r.totalClicks || 0);

    const C = { bg: "#06090F", surface: "#0C1018", card: "#111722", border: "#1B2233", accent: "#4F8FF7", accentDim: "rgba(79,143,247,0.10)", green: "#34D399", greenDim: "rgba(52,211,153,0.10)", amber: "#FBBF24", amberDim: "rgba(251,191,36,0.10)", red: "#F87171", redDim: "rgba(248,113,113,0.10)", purple: "#A78BFA", purpleDim: "rgba(167,139,250,0.10)", text: "#E2E8F0", muted: "#8494AB", dim: "#4A5A72", white: "#FFFFFF" };
    const FONT = "'Outfit',sans-serif";
    const MONO = "'IBM Plex Mono',monospace";

    // â”€â”€â”€ Get patterns array from sponsor (handles old single-pattern format) â”€â”€â”€â”€â”€
    function getPatterns(sponsor) {
      if (sponsor.urlPatterns && sponsor.urlPatterns.length > 0) return sponsor.urlPatterns;
      if (sponsor.urlPattern) return [sponsor.urlPattern];
      return [];
    }

    // â”€â”€â”€ Beehiiv API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchAllPosts(apiKey, pubId, maxPages = 5) {
      const res = await fetch("/api/sync", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey, pubId, maxPages }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
        throw new Error(err.error || `API error ${res.status}`);
      }
      return res.json();
    }

    async function fetchQuickSync(apiKey, pubId, knownPostIds) {
      const res = await fetch("/api/quick-sync", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ apiKey, pubId, knownPostIds }),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({ error: `HTTP ${res.status}` }));
        throw new Error(err.error || `API error ${res.status}`);
      }
      return await res.json();
    }

    function extractRun(post, patterns) {
      if (!post.stats) return null;
      const es = post.stats.email || {};
      const clicks = post.stats.clicks || [];
      let sc = 0, vc = 0, matched = [];
      for (const e of clicks) {
        const u = (e.url || e.base_url || "").toLowerCase();
        const hit = patterns.some(p => p && u.includes(p.toLowerCase()));
        if (hit) {
          sc += e.total_clicks || 0;
          vc += e.email?.verified_clicks || 0;
          matched.push({ url: e.url || e.base_url, clicks: e.total_clicks || 0, verifiedClicks: e.email?.verified_clicks || 0 });
        }
      }
      if (sc === 0) return null;
      return {
        postId: post.id,
        emailName: post.title || post.subject_line || "Untitled",
        webUrl: post.web_url || null,
        sendDate: tsToDate(post.publish_date) || tsToDate(post.created),
        totalOpens: es.opens || 0,
        totalClicks: sc,
        verifiedClicks: vc,
        matchedUrls: matched,
        recipients: es.recipients || 0,
        autoSynced: true,
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function App() {
      const [config, setConfig] = useState(() => store.get(KEYS.config) || { apiKey: "", pubId: "" });
      const [sponsors, setSponsors] = useState(() => store.get(KEYS.sponsors) || []);
      const [runs, setRuns] = useState(() => store.get(KEYS.runs) || []);
      const [sel, setSel] = useState(null);
      const [view, setView] = useState("admin");
      const [syncing, setSyncing] = useState(false);
      const [syncMsg, setSyncMsg] = useState(null);
      const [modal, setModal] = useState(null);
      const [editRun, setEditRun] = useState(null);
      const [syncDepth, setSyncDepth] = useState(5);
      const [contracts, setContracts] = useState(() => store.get(KEYS.contracts) || []);
      const [selContract, setSelContract] = useState(null);
      const [downloading, setDownloading] = useState(false);

      const saveCfg = (c) => { setConfig(c); store.set(KEYS.config, c); };
      const saveSp = (s) => { setSponsors(s); store.set(KEYS.sponsors, s); };
      const saveRn = (r) => { setRuns(r); store.set(KEYS.runs, r); };
      const saveCt = (ct) => { setContracts(ct); store.set(KEYS.contracts, ct); };

      // Sponsor CRUD
      const addSponsor = (name, patterns) => {
        const s = { id: uid(), name, urlPatterns: patterns.filter(p => p.trim()), created: new Date().toISOString() };
        saveSp([...sponsors, s]);
        setSel(s.id);
        setModal(null);
      };
      const updateSponsor = (id, updates) => {
        saveSp(sponsors.map(s => s.id === id ? { ...s, ...updates } : s));
      };
      const delSponsor = (id) => {
        if (!confirm("Delete sponsor and all runs?")) return;
        saveSp(sponsors.filter(s => s.id !== id));
        saveRn(runs.filter(r => r.sponsorId !== id));
        saveCt(contracts.filter(c => c.sponsorId !== id));
        if (sel === id) { setSel(null); setSelContract(null); }
      };

      // Run CRUD
      const addRunManual = (d) => { saveRn([...runs, { id: uid(), ...d }]); setModal(null); };
      const updateRunManual = (id, u) => { saveRn(runs.map(r => r.id === id ? { ...r, ...u } : r)); setModal(null); setEditRun(null); };
      const delRun = (id) => { if (confirm("Delete run?")) saveRn(runs.filter(r => r.id !== id)); };
      const toggleRunVerified = (id) => { saveRn(runs.map(r => r.id === id ? { ...r, useVerified: !r.useVerified } : r)); };

      // Contract CRUD
      const addContract = (data) => {
        const updated = contracts.map(c => c.sponsorId === data.sponsorId ? { ...c, isActive: false } : c);
        const nc = { id: uid(), ...data, isActive: true, created: new Date().toISOString() };
        saveCt([...updated, nc]);
        setSelContract(nc.id);
        setModal(null);
      };
      const updateContract = (id, updates) => {
        saveCt(contracts.map(c => c.id === id ? { ...c, ...updates } : c));
        setModal(null);
      };
      const delContract = (id) => {
        if (!confirm("Delete contract? Runs will become unassigned.")) return;
        saveRn(runs.map(r => r.contractId === id ? { ...r, contractId: null } : r));
        saveCt(contracts.filter(c => c.id !== id));
        if (selContract === id) setSelContract(null);
      };
      const activateContract = (id) => {
        const ct = contracts.find(c => c.id === id);
        if (!ct) return;
        saveCt(contracts.map(c => c.sponsorId === ct.sponsorId ? { ...c, isActive: c.id === id } : c));
        setSelContract(id);
      };

      // â”€â”€â”€ Sync logic â”€â”€â”€â”€
      const processResults = (allPosts, sponsorIds, currentRuns) => {
        let nw = 0, up = 0, list = [...currentRuns];
        for (const sid of sponsorIds) {
          const sp = sponsors.find(s => s.id === sid);
          if (!sp) continue;
          const patterns = getPatterns(sp);
          if (patterns.length === 0) continue;
          const existing = new Set(list.filter(r => r.sponsorId === sid).map(r => r.postId));
          for (const p of allPosts) {
            const ex = extractRun(p, patterns);
            if (!ex) continue;
            if (existing.has(p.id)) {
              list = list.map(r => r.sponsorId === sid && r.postId === p.id
                ? { ...r, totalOpens: ex.totalOpens, totalClicks: ex.totalClicks, verifiedClicks: ex.verifiedClicks, matchedUrls: ex.matchedUrls, recipients: ex.recipients, webUrl: ex.webUrl, lastSync: new Date().toISOString() }
                : r);
              up++;
            } else {
              const newRun = { id: uid(), sponsorId: sid, ...ex, contractId: null, useVerified: false, lastSync: new Date().toISOString() };
              // Auto-assign to active contract if it has capacity
              const ac = contracts.find(c => c.sponsorId === sid && c.isActive);
              if (ac) {
                const assigned = list.filter(r => r.contractId === ac.id).length;
                if (assigned < ac.totalRuns) newRun.contractId = ac.id;
              }
              list.push(newRun);
              nw++;
            }
          }
        }
        return { list, nw, up };
      };

      // Full sync with depth control
      const doSync = async (sponsorIds, pages = syncDepth) => {
        if (!config.apiKey || !config.pubId) { setSyncMsg({ t: "err", m: "Set API key & Pub ID in Settings first." }); return; }
        setSyncing(true); setSyncMsg(null);
        try {
          const data = await fetchAllPosts(config.apiKey, config.pubId, pages);
          const allPosts = data.posts || [];
          const { list, nw, up } = processResults(allPosts, sponsorIds, runs);
          saveRn(list);
          let msg = `Done! ${nw} new, ${up} updated (${allPosts.length} posts scanned, ${data.pagesScanned || '?'}/${data.totalPages || '?'} pages).`;
          if (data.warning) msg += ` âš ï¸ ${data.warning}`;
          setSyncMsg({ t: "ok", m: msg });
        } catch (e) {
          setSyncMsg({ t: "err", m: `Failed: ${e.message}` });
        } finally { setSyncing(false); }
      };

      // Quick sync for background auto-refresh
      const doQuickSync = async (sponsorIds, silent = false) => {
        if (!config.apiKey || !config.pubId) return;
        if (syncing) return;
        if (!silent) setSyncing(true);
        try {
          const knownPostIds = [...new Set(runs.filter(r => sponsorIds.includes(r.sponsorId) && r.postId).map(r => r.postId))];
          const data = await fetchQuickSync(config.apiKey, config.pubId, knownPostIds);
          const allPosts = data.posts || [];
          const { list, nw, up } = processResults(allPosts, sponsorIds, runs);
          saveRn(list);
          if (!silent && (nw > 0 || up > 0)) setSyncMsg({ t: "ok", m: `Quick sync: ${nw} new, ${up} updated.` });
        } catch (e) {
          if (!silent) setSyncMsg({ t: "err", m: `Quick sync failed: ${e.message}` });
        } finally { if (!silent) setSyncing(false); }
      };

      const syncOne = (sid, pages) => doSync([sid], pages);
      const syncAll = () => doSync(sponsors.map(s => s.id), syncDepth);

      // Derived
      const sponsor = sponsors.find(s => s.id === sel);
      const sponsorContracts = contracts.filter(c => c.sponsorId === sel).sort((a, b) => new Date(b.created) - new Date(a.created));
      const activeContract = sponsorContracts.find(c => c.isActive);
      const viewingContract = selContract ? contracts.find(c => c.id === selContract) : null;

      const allSponsorRuns = runs.filter(r => r.sponsorId === sel).sort((a, b) => new Date(b.sendDate) - new Date(a.sendDate));
      const sRuns = viewingContract
        ? allSponsorRuns.filter(r => r.contractId === viewingContract.id)
        : allSponsorRuns;

      const tot = { opens: sRuns.reduce((s, r) => s + (r.totalOpens || 0), 0), clicks: sRuns.reduce((s, r) => s + getRunClicks(r), 0) };
      tot.ctr = tot.opens > 0 ? (tot.clicks / tot.opens) * 100 : 0;

      const costMetrics = viewingContract && viewingContract.totalPrice > 0 ? (() => {
        const runsDelivered = sRuns.length;
        const spent = (runsDelivered / viewingContract.totalRuns) * viewingContract.totalPrice;
        return {
          costPerRun: viewingContract.totalPrice / viewingContract.totalRuns,
          cpm: tot.opens > 0 ? (spent / tot.opens) * 1000 : 0,
          cpc: tot.clicks > 0 ? spent / tot.clicks : 0,
        };
      })() : null;

      // Sponsor view â€” uses per-run toggle transparently, filters to active contract
      if (view === "sponsor" && sponsor) {
        const svContract = activeContract;
        const svRuns = svContract
          ? allSponsorRuns.filter(r => r.contractId === svContract.id)
          : allSponsorRuns;
        const svTot = { opens: svRuns.reduce((s, r) => s + (r.totalOpens || 0), 0), clicks: svRuns.reduce((s, r) => s + getRunClicks(r), 0) };
        svTot.ctr = svTot.opens > 0 ? (svTot.clicks / svTot.opens) * 100 : 0;
        const svCostMetrics = svContract && svContract.totalPrice > 0 ? (() => {
          const spent = (svRuns.length / svContract.totalRuns) * svContract.totalPrice;
          return {
            cpm: svTot.opens > 0 ? (spent / svTot.opens) * 1000 : 0,
            cpc: svTot.clicks > 0 ? spent / svTot.clicks : 0,
          };
        })() : null;
        return <SponsorView sponsor={sponsor} runs={svRuns} totals={svTot} contract={svContract} costMetrics={svCostMetrics} onBack={() => setView("admin")} onQuickSync={() => doQuickSync([sel], true)} config={config} />;
      }

      return (
        <div style={{ display: "flex", minHeight: "100vh" }}>
          {/* Sidebar */}
          <aside style={{ width: 272, borderRight: `1px solid ${C.border}`, display: "flex", flexDirection: "column", background: C.surface, flexShrink: 0 }}>
            <div style={{ padding: "24px 20px 16px" }}>
              <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 4 }}>
                <div style={{ width: 28, height: 28, borderRadius: 8, background: `linear-gradient(135deg,${C.accent},#8B5CF6)`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 13, color: "#fff", fontWeight: 700 }}>S</div>
                <h1 style={{ fontSize: 15, fontWeight: 700, letterSpacing: -0.3 }}>Sponsor Dash</h1>
              </div>
              <p style={{ fontSize: 11, color: C.dim, margin: "4px 0 0 38px" }}>Beehiiv Campaign Tracker</p>
            </div>
            <div style={{ padding: "0 12px", display: "flex", gap: 6, marginBottom: 4 }}>
              <Btn onClick={() => setModal("addSponsor")} color={C.accent} bg={C.accentDim} style={{ flex: 1 }}>+ Sponsor</Btn>
              <Btn onClick={() => setModal("settings")} color={C.muted} bg="transparent" style={{ border: `1px solid ${C.border}`, padding: "8px 12px" }}>âš™</Btn>
            </div>
            {config.apiKey && <div style={{ padding: "8px 12px 4px" }}><Btn onClick={syncAll} color={C.green} bg={C.greenDim} disabled={syncing} style={{ width: "100%" }}>{syncing ? "Syncing..." : "âŸ³ Sync All"}</Btn></div>}
            {config.apiKey && <div style={{ padding: "8px 16px 0", display: "flex", alignItems: "center", gap: 6 }}><div style={{ width: 6, height: 6, borderRadius: 3, background: C.green }} /><span style={{ fontSize: 11, color: C.green }}>API Connected</span></div>}
            <div style={{ flex: 1, overflow: "auto", padding: "12px 0 4px" }}>
              {sponsors.map(s => {
                const cnt = runs.filter(r => r.sponsorId === s.id).length;
                const pats = getPatterns(s);
                return (
                  <div key={s.id} onClick={() => { setSel(s.id); setSelContract(null); setModal(null); setEditRun(null); setSyncMsg(null); }}
                    style={{ padding: "14px 20px", cursor: "pointer", background: sel === s.id ? C.accentDim : "transparent", borderLeft: `3px solid ${sel === s.id ? C.accent : "transparent"}`, transition: "all 0.12s" }}>
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center" }}>
                      <p style={{ fontSize: 14, fontWeight: sel === s.id ? 600 : 400, color: sel === s.id ? C.white : C.text }}>{s.name}</p>
                      {cnt > 0 && <span style={{ fontSize: 10, padding: "2px 7px", borderRadius: 10, background: C.accentDim, color: C.accent, fontWeight: 600 }}>{cnt}</span>}
                    </div>
                    <p style={{ fontSize: 10, color: C.dim, margin: "3px 0 0", fontFamily: MONO }}>{pats.length} pattern{pats.length !== 1 ? "s" : ""}</p>
                  </div>
                );
              })}
              {sponsors.length === 0 && <p style={{ fontSize: 12, color: C.dim, padding: "24px 20px", textAlign: "center" }}>Add a sponsor to get started</p>}
            </div>
          </aside>

          {/* Main */}
          <main style={{ flex: 1, padding: 32, overflow: "auto" }}>
            {!sel && (
              <div style={{ display: "flex", alignItems: "center", justifyContent: "center", height: "100%", flexDirection: "column", gap: 16 }}>
                <div style={{ width: 64, height: 64, borderRadius: 16, background: C.card, border: `1px solid ${C.border}`, display: "flex", alignItems: "center", justifyContent: "center", fontSize: 28 }}>ğŸ“Š</div>
                <p style={{ color: C.dim, fontSize: 15, fontWeight: 500 }}>Select a sponsor to view their data</p>
                {!config.apiKey && <Btn onClick={() => setModal("settings")} color={C.accent} bg={C.accentDim}>Connect Beehiiv API â†’</Btn>}
              </div>
            )}

            {sel && sponsor && (
              <div className="fade-in">
                {/* Header */}
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 20, flexWrap: "wrap", gap: 12 }}>
                  <div>
                    <h2 style={{ fontSize: 26, fontWeight: 700, letterSpacing: -0.5 }}>{sponsor.name}</h2>
                  </div>
                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap", alignItems: "center" }}>
                    {sRuns.length > 0 && <button onClick={async () => { setDownloading(true); try { await downloadReport({ sponsor, contract: viewingContract, runs: sRuns, totals: tot, costMetrics, config }); } catch(e) { console.error(e); } finally { setDownloading(false); } }} disabled={downloading} style={{ background: "none", border: `1px solid ${C.border}`, borderRadius: 8, color: downloading ? C.dim : C.muted, cursor: downloading ? "not-allowed" : "pointer", fontFamily: FONT, fontSize: 12, fontWeight: 600, padding: "8px 14px", opacity: downloading ? 0.6 : 1 }}>{downloading ? "Generating..." : "â†“ Download Report"}</button>}
                    <Btn onClick={() => setView("sponsor")} color={C.accent} bg={C.accentDim}>Sponsor View</Btn>
                    <Btn onClick={() => delSponsor(sponsor.id)} color={C.red} bg={C.redDim}>Delete</Btn>
                  </div>
                </div>

                {/* Pattern Management */}
                <PatternManager sponsor={sponsor} onUpdate={(patterns) => updateSponsor(sponsor.id, { urlPatterns: patterns })} />

                {/* Contract Management */}
                <ContractManager
                  sponsorId={sel}
                  contracts={sponsorContracts}
                  activeContract={activeContract}
                  viewingContract={viewingContract}
                  runs={allSponsorRuns}
                  onActivate={activateContract}
                  onSelect={(id) => setSelContract(id)}
                  onClearFilter={() => setSelContract(null)}
                  onDelete={delContract}
                  onSetModal={setModal}
                  onEditContract={(ct) => { setSelContract(ct.id); setModal("editContract"); }}
                />

                {/* Sync Controls */}
                {config.apiKey && getPatterns(sponsor).length > 0 && (
                  <div style={{ display: "flex", gap: 8, alignItems: "center", marginBottom: 20, flexWrap: "wrap" }}>
                    <Btn onClick={() => syncOne(sponsor.id, syncDepth)} color={C.white} bg={C.accent} disabled={syncing}>{syncing ? "Syncing..." : "âŸ³ Sync"}</Btn>
                    <div style={{ display: "flex", alignItems: "center", gap: 6, background: C.card, border: `1px solid ${C.border}`, borderRadius: 8, padding: "4px 10px" }}>
                      <span style={{ fontSize: 11, color: C.dim }}>Depth:</span>
                      {[5, 15, 30, 50].map(d => (
                        <button key={d} onClick={() => setSyncDepth(d)} style={{
                          padding: "4px 8px", borderRadius: 6, border: "none", fontSize: 11, fontWeight: 600, fontFamily: FONT, cursor: "pointer",
                          background: syncDepth === d ? C.accent : "transparent", color: syncDepth === d ? "#fff" : C.dim,
                        }}>{d * 10}</button>
                      ))}
                      <span style={{ fontSize: 10, color: C.dim }}>posts</span>
                    </div>
                  </div>
                )}

                {syncMsg && <div style={{ padding: "12px 16px", borderRadius: 10, marginBottom: 20, fontSize: 13, background: syncMsg.t === "ok" ? C.greenDim : C.redDim, color: syncMsg.t === "ok" ? C.green : C.red, border: `1px solid ${syncMsg.t === "ok" ? "rgba(52,211,153,0.2)" : "rgba(248,113,113,0.2)"}` }}>{syncMsg.m}</div>}

                {/* Cumulative Reach */}
                {sRuns.length > 0 && <ReachSection runs={sRuns} />}

                {/* Stats */}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 16, marginBottom: costMetrics ? 16 : 32 }}>
                  <MetricCard label="Total Opens" value={num(tot.opens)} sub={`${sRuns.length} run${sRuns.length !== 1 ? "s" : ""}`} color={C.accent} />
                  <MetricCard label="Total Clicks" value={num(tot.clicks)} sub="all matching links" color={C.green} />
                  <MetricCard label="Click-Through Rate" value={pct(tot.ctr)} sub="clicks Ã· opens" color={C.amber} />
                </div>

                {/* Cost Metrics */}
                {costMetrics && (
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 16, marginBottom: viewingContract && getTerms(viewingContract).length > 0 ? 12 : 32 }}>
                    <MetricCard label="Cost Per Run" value={money(costMetrics.costPerRun)} sub={`${money(viewingContract.totalPrice)} Ã· ${viewingContract.totalRuns} runs`} color={C.purple} />
                    <MetricCard label="CPM" value={money(costMetrics.cpm)} sub="cost per 1,000 opens" color={C.purple} />
                    <MetricCard label="CPC" value={money(costMetrics.cpc)} sub="cost per click" color={C.purple} />
                  </div>
                )}
                {costMetrics && viewingContract && <TermsBadges contract={viewingContract} style={{ marginBottom: 32 }} />}

                {/* Runs */}
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 16 }}>
                  <h3 style={{ fontSize: 15, fontWeight: 600, color: C.muted }}>Campaign Runs</h3>
                  <Btn onClick={() => { setModal("addRun"); setEditRun(null); }} color={C.green} bg={C.greenDim}>+ Manual Run</Btn>
                </div>

                {sRuns.length > 0 && (
                  <div style={{ background: C.card, borderRadius: 14, border: `1px solid ${C.border}`, overflow: "hidden" }}>
                    <div style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1.2fr 0.8fr auto", padding: "12px 20px", borderBottom: `1px solid ${C.border}`, gap: 12 }}>
                      {["Email", "Opens", "Clicks", "CTR", ""].map(h => <p key={h} style={{ fontSize: 10, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.5, color: C.dim, textAlign: h !== "Email" && h !== "" ? "center" : "left" }}>{h}</p>)}
                    </div>
                    {sRuns.map((r, i) => {
                      const clicks = getRunClicks(r);
                      const ctr = r.totalOpens > 0 ? (clicks / r.totalOpens) * 100 : 0;
                      return (
                        <div key={r.id} style={{ display: "grid", gridTemplateColumns: "2fr 1fr 1.2fr 0.8fr auto", padding: "16px 20px", borderBottom: i < sRuns.length - 1 ? `1px solid ${C.border}` : "none", gap: 12, alignItems: "center" }}>
                          <div>
                            <div style={{ display: "flex", alignItems: "center", gap: 6 }}>
                              {r.webUrl
                                ? <a href={r.webUrl} target="_blank" rel="noopener noreferrer" style={{ fontSize: 14, fontWeight: 500, textDecoration: "none", borderBottom: `1px dotted ${C.dim}` }}>{r.emailName}</a>
                                : <p style={{ fontSize: 14, fontWeight: 500 }}>{r.emailName}</p>
                              }
                              {r.adminNote && <span title={r.adminNote} style={{ cursor: "help", fontSize: 13 }}>ğŸ“</span>}
                            </div>
                            {r.description && <p style={{ fontSize: 12, color: C.muted, fontStyle: "italic", margin: "2px 0 0" }}>{r.description}</p>}
                            <div style={{ display: "flex", alignItems: "center", gap: 6, marginTop: 3, flexWrap: "wrap" }}>
                              <span style={{ fontSize: 12, color: C.dim }}>{fmtDate(r.sendDate)}</span>
                              {r.autoSynced && <span style={{ fontSize: 9, padding: "2px 6px", borderRadius: 4, background: C.accentDim, color: C.accent, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.5 }}>API</span>}
                              {r.contractId
                                ? <span style={{ fontSize: 9, padding: "2px 6px", borderRadius: 4, background: C.purpleDim, color: C.purple, fontWeight: 600, letterSpacing: 0.3 }}>{contracts.find(c => c.id === r.contractId)?.name || "?"}</span>
                                : sponsorContracts.length > 0 && <span style={{ fontSize: 9, padding: "2px 6px", borderRadius: 4, background: C.card, color: C.dim, fontWeight: 500 }}>unassigned</span>
                              }
                            </div>
                          </div>
                          <p style={{ textAlign: "center", fontFamily: MONO, fontSize: 16, fontWeight: 600, color: C.accent }}>{num(r.totalOpens)}</p>
                          <div style={{ display: "flex", alignItems: "center", justifyContent: "center", gap: 6 }}>
                            <span style={{ fontFamily: MONO, fontSize: 16, fontWeight: 600, color: C.green }}>{num(clicks)}</span>
                            {r.useVerified && <span style={{ fontSize: 11, color: C.green, fontWeight: 700 }}>âœ“</span>}
                            <button onClick={() => toggleRunVerified(r.id)} title={r.useVerified ? "Using verified clicks â€” click to switch to total" : "Using total clicks â€” click to switch to verified"} style={{
                              width: 28, height: 16, borderRadius: 8, padding: 2, border: "none", cursor: "pointer",
                              background: r.useVerified ? C.green : C.dim, display: "flex", alignItems: "center", transition: "background 0.15s",
                            }}>
                              <div style={{ width: 12, height: 12, borderRadius: 6, background: "#fff", transform: r.useVerified ? "translateX(12px)" : "translateX(0)", transition: "transform 0.15s" }} />
                            </button>
                          </div>
                          <p style={{ textAlign: "center", fontFamily: MONO, fontSize: 16, fontWeight: 600, color: C.amber }}>{pct(ctr)}</p>
                          <div style={{ display: "flex", gap: 4 }}>
                            <Btn onClick={() => { setEditRun(r); setModal("editRun"); }} color={C.accent} bg={C.accentDim} small>Edit</Btn>
                            <Btn onClick={() => delRun(r.id)} color={C.red} bg={C.redDim} small>Ã—</Btn>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}

                {sRuns.length === 0 && (
                  <div style={{ textAlign: "center", padding: "48px 24px", background: C.card, borderRadius: 14, border: `1px solid ${C.border}` }}>
                    <p style={{ color: C.dim, fontSize: 14, marginBottom: 16 }}>No runs yet</p>
                    <div style={{ display: "flex", gap: 8, justifyContent: "center" }}>
                      {config.apiKey && getPatterns(sponsor).length > 0 && <Btn onClick={() => syncOne(sponsor.id, syncDepth)} color={C.white} bg={C.accent} disabled={syncing}>{syncing ? "Syncing..." : "âŸ³ Sync from Beehiiv"}</Btn>}
                      <Btn onClick={() => { setModal("addRun"); setEditRun(null); }} color={C.green} bg={C.greenDim}>+ Add Manually</Btn>
                    </div>
                  </div>
                )}

                {sRuns.some(r => r.matchedUrls?.length > 0) && (() => {
                  const latestRun = sRuns.find(r => r.matchedUrls?.length);
                  return (
                  <div style={{ marginTop: 24 }}>
                    <h3 style={{ fontSize: 13, fontWeight: 600, margin: "0 0 12px", color: C.dim, textTransform: "uppercase", letterSpacing: 1 }}>Matched URLs (latest run)</h3>
                    <div style={{ background: C.card, borderRadius: 12, border: `1px solid ${C.border}`, padding: "4px 16px" }}>
                      {(latestRun?.matchedUrls || []).map((u, i, a) => (
                        <div key={i} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "10px 0", borderBottom: i < a.length - 1 ? `1px solid ${C.border}` : "none" }}>
                          <p style={{ fontSize: 12, fontFamily: MONO, color: C.muted, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap", maxWidth: "80%" }}>{u.url}</p>
                          <p style={{ fontSize: 13, fontFamily: MONO, fontWeight: 600, color: C.green }}>{num(latestRun.useVerified ? (u.verifiedClicks || 0) : u.clicks)}</p>
                        </div>
                      ))}
                    </div>
                  </div>
                  );
                })()}
              </div>
            )}
          </main>

          {modal === "settings" && <Overlay onClose={() => setModal(null)}><SettingsForm config={config} onSave={c => { saveCfg(c); setModal(null); }} onCancel={() => setModal(null)} /></Overlay>}
          {modal === "addSponsor" && <Overlay onClose={() => setModal(null)}><AddSponsorForm onSave={addSponsor} onCancel={() => setModal(null)} /></Overlay>}
          {(modal === "addRun" || modal === "editRun") && <Overlay onClose={() => { setModal(null); setEditRun(null); }}><RunForm sponsorId={sel} run={editRun} contracts={sponsorContracts} activeContract={activeContract} onSave={d => editRun ? updateRunManual(editRun.id, d) : addRunManual(d)} onCancel={() => { setModal(null); setEditRun(null); }} /></Overlay>}
          {modal === "addContract" && <Overlay onClose={() => setModal(null)}><ContractForm sponsorId={sel} contract={null} onSave={addContract} onCancel={() => setModal(null)} /></Overlay>}
          {modal === "editContract" && viewingContract && <Overlay onClose={() => setModal(null)}><ContractForm sponsorId={sel} contract={viewingContract} onSave={d => updateContract(viewingContract.id, d)} onCancel={() => setModal(null)} /></Overlay>}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PATTERN MANAGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function PatternManager({ sponsor, onUpdate }) {
      const [newPat, setNewPat] = useState("");
      const patterns = getPatterns(sponsor);

      const add = () => {
        const val = newPat.trim();
        if (!val || patterns.includes(val)) return;
        onUpdate([...patterns, val]);
        setNewPat("");
      };

      const remove = (idx) => {
        onUpdate(patterns.filter((_, i) => i !== idx));
      };

      return (
        <div style={{ marginBottom: 20, background: C.card, border: `1px solid ${C.border}`, borderRadius: 12, padding: 16 }}>
          <p style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 10 }}>URL Patterns</p>

          {/* Existing patterns */}
          <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: patterns.length > 0 ? 10 : 0 }}>
            {patterns.map((p, i) => (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 6, background: C.bg, border: `1px solid ${C.border}`, borderRadius: 8, padding: "6px 10px" }}>
                <span style={{ fontSize: 12, fontFamily: MONO, color: C.text }}>{p}</span>
                <button onClick={() => remove(i)} style={{ background: "none", border: "none", color: C.red, cursor: "pointer", fontSize: 14, padding: "0 2px", fontWeight: 700, lineHeight: 1 }}>Ã—</button>
              </div>
            ))}
          </div>

          {/* Add new */}
          <div style={{ display: "flex", gap: 6 }}>
            <input
              value={newPat}
              onChange={e => setNewPat(e.target.value)}
              onKeyDown={e => e.key === "Enter" && add()}
              placeholder="Add URL pattern (e.g. vpdae, go.themommy.news/kp)"
              style={{ flex: 1, padding: "8px 12px", background: C.bg, border: `1px solid ${C.border}`, borderRadius: 8, color: C.text, fontFamily: MONO, fontSize: 12, outline: "none", boxSizing: "border-box" }}
            />
            <Btn onClick={add} color={C.green} bg={C.greenDim} disabled={!newPat.trim()}>Add</Btn>
          </div>
          <p style={{ fontSize: 10, color: C.dim, marginTop: 6 }}>Each pattern matches any click URL containing that text. All matching links across all patterns get summed together.</p>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTRACT MANAGER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ContractManager({ sponsorId, contracts, activeContract, viewingContract, runs, onActivate, onSelect, onClearFilter, onDelete, onSetModal, onEditContract }) {
      return (
        <div style={{ marginBottom: 20, background: C.card, border: `1px solid ${C.border}`, borderRadius: 12, padding: 16 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: contracts.length > 0 ? 12 : 0 }}>
            <p style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted }}>Contracts</p>
            <div style={{ display: "flex", gap: 6 }}>
              {viewingContract && <Btn onClick={onClearFilter} color={C.dim} bg="transparent" small style={{ border: `1px solid ${C.border}` }}>Show All Runs</Btn>}
              <Btn onClick={() => onSetModal("addContract")} color={C.purple} bg={C.purpleDim} small>+ New Contract</Btn>
            </div>
          </div>

          {contracts.length === 0 && (
            <p style={{ fontSize: 12, color: C.dim, padding: "8px 0" }}>No contracts yet. Create one to group runs and track costs.</p>
          )}

          {contracts.map(ct => {
            const assigned = runs.filter(r => r.contractId === ct.id).length;
            const remaining = ct.totalRuns - assigned;
            const pctVal = ct.totalRuns > 0 ? Math.min((assigned / ct.totalRuns) * 100, 100) : 0;
            const barColor = remaining <= 0 ? C.red : remaining === 1 ? C.amber : C.green;
            const isViewing = viewingContract && viewingContract.id === ct.id;
            return (
              <div key={ct.id}
                onClick={() => onSelect(ct.id)}
                style={{
                  padding: "12px 14px", borderRadius: 10, marginBottom: 6, cursor: "pointer",
                  background: isViewing ? C.purpleDim : C.bg,
                  border: `1px solid ${ct.isActive ? "rgba(167,139,250,0.3)" : C.border}`,
                  opacity: ct.isActive ? 1 : 0.7,
                  transition: "all 0.12s",
                }}>
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 6 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontSize: 13, fontWeight: 600, color: isViewing ? C.purple : C.text }}>{ct.name}</span>
                    {ct.isActive && <span style={{ fontSize: 9, padding: "2px 6px", borderRadius: 4, background: C.greenDim, color: C.green, fontWeight: 600, textTransform: "uppercase", letterSpacing: 0.5 }}>Active</span>}
                  </div>
                  <div style={{ display: "flex", gap: 4 }} onClick={e => e.stopPropagation()}>
                    {!ct.isActive && <Btn onClick={() => onActivate(ct.id)} color={C.green} bg={C.greenDim} small>Activate</Btn>}
                    <Btn onClick={() => onEditContract(ct)} color={C.accent} bg={C.accentDim} small>Edit</Btn>
                    <Btn onClick={() => onDelete(ct.id)} color={C.red} bg={C.redDim} small>Ã—</Btn>
                  </div>
                </div>
                <div style={{ display: "flex", alignItems: "center", gap: 12, fontSize: 11, color: C.dim, marginBottom: 6 }}>
                  {ct.totalPrice > 0 && <span style={{ fontFamily: MONO }}>{money(ct.totalPrice)}</span>}
                  <span>{assigned} / {ct.totalRuns} runs</span>
                  {ct.startDate && <span>{fmtDate(ct.startDate)} â€” {fmtDate(ct.endDate)}</span>}
                  {(() => { const cpm = ct.showCpmToSponsor ?? ct.showPricingToSponsor; const cpc = ct.showCpcToSponsor ?? ct.showPricingToSponsor; return (cpm || cpc) ? <span style={{ color: C.purple }}>{cpm && cpc ? "CPM + CPC visible" : cpm ? "CPM visible" : "CPC visible"}</span> : null; })()}
                </div>
                <div style={{ height: 4, background: C.border, borderRadius: 2, overflow: "hidden" }}>
                  <div style={{ height: "100%", width: `${pctVal}%`, background: barColor, borderRadius: 2, transition: "width 0.3s" }} />
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SPONSOR VIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function SponsorView({ sponsor, runs, totals, contract, costMetrics, onBack, onQuickSync, config }) {
      const [dlPdf, setDlPdf] = useState(false);
      useEffect(() => {
        onQuickSync();
        const interval = setInterval(onQuickSync, 5 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      const showCpm = contract ? (contract.showCpmToSponsor ?? contract.showPricingToSponsor ?? false) : false;
      const showCpc = contract ? (contract.showCpcToSponsor ?? contract.showPricingToSponsor ?? false) : false;
      const hasAnyCost = (showCpm || showCpc) && costMetrics;
      const terms = contract ? getTerms(contract) : [];

      const handleDownload = async () => {
        setDlPdf(true);
        try { await downloadReport({ sponsor, contract, runs, totals, costMetrics, config }); }
        catch (e) { console.error(e); }
        finally { setDlPdf(false); }
      };

      return (
        <div style={{ minHeight: "100vh" }}>
          <div style={{ padding: "14px 32px", borderBottom: `1px solid ${C.border}`, display: "flex", justifyContent: "space-between", alignItems: "center" }}>
            <button onClick={onBack} style={{ background: "none", border: "none", color: C.dim, cursor: "pointer", fontFamily: FONT, fontSize: 13 }}>â† Back to Admin</button>
            <div style={{ display: "flex", alignItems: "center", gap: 12 }}>
              {runs.length > 0 && <button onClick={handleDownload} disabled={dlPdf} style={{ background: "none", border: `1px solid ${C.border}`, borderRadius: 8, color: dlPdf ? C.dim : C.muted, cursor: dlPdf ? "not-allowed" : "pointer", fontFamily: FONT, fontSize: 12, fontWeight: 600, padding: "6px 14px", opacity: dlPdf ? 0.6 : 1 }}>{dlPdf ? "Generating..." : "â†“ Download Report"}</button>}
              <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                <div style={{ width: 6, height: 6, borderRadius: 3, background: C.green, animation: "pulse 2s infinite" }} />
                <span style={{ fontSize: 11, color: C.dim }}>Live â€¢ auto-updates every 5 min</span>
              </div>
            </div>
          </div>
          <div style={{ maxWidth: 940, margin: "0 auto", padding: "56px 28px" }}>
            <div style={{ marginBottom: 40 }}>
              <p style={{ fontSize: 12, fontWeight: 600, color: C.dim, textTransform: "uppercase", letterSpacing: 2, marginBottom: 12 }}>Campaign Performance Report</p>
              <h1 style={{ fontSize: 42, fontWeight: 700, letterSpacing: -1, lineHeight: 1.1 }}>{sponsor.name}</h1>
            </div>

            {/* Progress bar */}
            {contract && <ProgressBar current={runs.length} total={contract.totalRuns} />}

            {/* Cumulative Reach */}
            {runs.length > 0 && <ReachSection runs={runs} />}

            <div style={{ display: "grid", gridTemplateColumns: "repeat(3,1fr)", gap: 20, marginBottom: hasAnyCost ? 20 : 56 }}>
              <BigStat label="Total Opens" value={num(totals.opens)} color={C.accent} sub={`${runs.length} email${runs.length !== 1 ? "s" : ""} sent`} />
              <BigStat label="Total Clicks" value={num(totals.clicks)} color={C.green} sub="across all campaign links" />
              <BigStat label="Click-Through Rate" value={pct(totals.ctr)} color={C.amber} sub="clicks Ã· opens" />
            </div>

            {/* Cost metrics â€” independent CPM/CPC visibility */}
            {hasAnyCost && (
              <div style={{ display: "grid", gridTemplateColumns: showCpm && showCpc ? "repeat(2,1fr)" : "1fr", gap: 20, marginBottom: terms.length > 0 ? 12 : 56 }}>
                {showCpm && <BigStat label="CPM" value={money(costMetrics.cpm)} color={C.purple} sub="cost per 1,000 opens" />}
                {showCpc && <BigStat label="CPC" value={money(costMetrics.cpc)} color={C.purple} sub="cost per click" />}
              </div>
            )}
            {hasAnyCost && <TermsBadges contract={contract} style={{ marginBottom: 56 }} />}
            {runs.length > 0 && (
              <React.Fragment>
                <h2 style={{ fontSize: 14, fontWeight: 600, color: C.muted, margin: "0 0 20px", textTransform: "uppercase", letterSpacing: 1.5 }}>Run-by-Run Breakdown</h2>
                <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                  {runs.map(r => {
                    const clicks = getRunClicks(r);
                    const ctr = r.totalOpens > 0 ? (clicks / r.totalOpens) * 100 : 0;
                    return (
                      <div key={r.id} style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 14, padding: "24px 28px", display: "grid", gridTemplateColumns: "1.8fr 1fr 1fr 0.8fr", alignItems: "center", gap: 20 }}>
                        <div>
                          {r.webUrl
                            ? <a href={r.webUrl} target="_blank" rel="noopener noreferrer" style={{ fontSize: 16, fontWeight: 600, textDecoration: "none", borderBottom: `1px solid ${C.dim}` }}>{r.emailName}</a>
                            : <p style={{ fontSize: 16, fontWeight: 600 }}>{r.emailName}</p>
                          }
                          {r.description && <p style={{ fontSize: 13, color: C.muted, fontStyle: "italic", margin: "4px 0 0" }}>{r.description}</p>}
                          <p style={{ fontSize: 13, color: C.dim, margin: "4px 0 0" }}>{fmtDate(r.sendDate)}</p>
                        </div>
                        <NumDisplay label="Opens" value={num(r.totalOpens)} color={C.accent} />
                        <NumDisplay label="Clicks" value={num(clicks)} color={C.green} />
                        <NumDisplay label="CTR" value={pct(ctr)} color={C.amber} />
                      </div>
                    );
                  })}
                </div>
              </React.Fragment>
            )}
            {runs.length === 0 && <div style={{ textAlign: "center", padding: 64, color: C.dim }}><p style={{ fontSize: 16 }}>Campaign data will appear here after the first send.</p></div>}
            <div style={{ marginTop: 72, paddingTop: 24, borderTop: `1px solid ${C.border}`, textAlign: "center" }}>
              <p style={{ fontSize: 12, color: C.dim }}>Metrics auto-update every 5 minutes â€¢ Synced via Beehiiv API</p>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SHARED COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function ProgressBar({ current, total }) {
      const pctVal = total > 0 ? Math.min((current / total) * 100, 100) : 0;
      const remaining = total - current;
      const barColor = remaining <= 0 ? C.red : remaining === 1 ? C.amber : C.green;
      return (
        <div style={{ marginBottom: 32, background: C.card, border: `1px solid ${C.border}`, borderRadius: 12, padding: "16px 20px" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 8 }}>
            <span style={{ fontSize: 13, fontWeight: 600, color: C.text }}>{current} of {total} emails sent</span>
            <span style={{ fontSize: 12, color: C.dim }}>{remaining > 0 ? `${remaining} remaining` : "Complete"}</span>
          </div>
          <div style={{ height: 6, background: C.bg, borderRadius: 3, overflow: "hidden" }}>
            <div style={{ height: "100%", width: `${pctVal}%`, background: barColor, borderRadius: 3, transition: "width 0.3s" }} />
          </div>
        </div>
      );
    }

    function TermsBadges({ contract, style = {} }) {
      const terms = getTerms(contract);
      if (terms.length === 0) return null;
      return (
        <div style={{ display: "flex", gap: 8, flexWrap: "wrap", ...style }}>
          {terms.map((t, i) => (
            <span key={i} style={{ padding: "6px 14px", borderRadius: 20, background: C.purpleDim, border: "1px solid rgba(167,139,250,0.25)", color: C.purple, fontSize: 12, fontWeight: 600, letterSpacing: 0.5 }}>âœ¦ {t}</span>
          ))}
        </div>
      );
    }

    function buildChartData(runs) {
      const sorted = [...runs].filter(r => r.sendDate).sort((a, b) => new Date(a.sendDate) - new Date(b.sendDate));
      if (sorted.length === 0) return [];
      const points = [];
      let cumulative = 0;
      sorted.forEach((run, i) => {
        const runOpens = run.totalOpens || 0;
        const runDate = new Date(run.sendDate);
        if (i === 0) {
          const preDate = new Date(runDate);
          preDate.setDate(preDate.getDate() - 3);
          points.push({ date: preDate, total: 0, isSend: false, label: null });
        }
        if (i > 0) {
          const prevDate = new Date(sorted[i - 1].sendDate);
          const daysBetween = Math.round((runDate - prevDate) / (1000 * 60 * 60 * 24));
          const prevTotal = cumulative;
          for (let d = 1; d < daysBetween; d++) {
            const t = d / daysBetween;
            const eased = 1 - Math.pow(1 - t, 2);
            const interpDate = new Date(prevDate);
            interpDate.setDate(interpDate.getDate() + d);
            points.push({ date: interpDate, total: Math.round(prevTotal + (runOpens * eased * 0.3)), isSend: false, label: null });
          }
        }
        cumulative += runOpens;
        points.push({ date: runDate, total: cumulative, isSend: true, label: run.emailName });
      });
      const today = new Date();
      const lastSend = new Date(sorted[sorted.length - 1].sendDate);
      if (today > lastSend) {
        const daysSince = Math.round((today - lastSend) / (1000 * 60 * 60 * 24));
        for (let d = 1; d <= Math.min(daysSince, 7); d++) {
          const postDate = new Date(lastSend);
          postDate.setDate(postDate.getDate() + d);
          points.push({ date: postDate, total: cumulative, isSend: false, label: null });
        }
      }
      return points;
    }

    function buildReportHTML({ sponsor, contract, runs, totals, costMetrics, config }) {
      const P = { bg: "#FFFFFF", text: "#1A1A2E", muted: "#6B7280", border: "#E5E7EB", card: "#F9FAFB", blue: "#2563EB", green: "#059669", amber: "#D97706", purple: "#7C3AED" };
      const F = "Arial, Helvetica, sans-serif";
      const n = (v) => (v || 0).toLocaleString();
      const p = (v) => (v || 0).toFixed(2) + "%";
      const m = (v) => "$" + (v || 0).toFixed(2);
      const fd = (d) => { if (!d) return "â€”"; return new Date(d).toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }); };

      const showCpm = contract ? (contract.showCpmToSponsor ?? contract.showPricingToSponsor ?? false) : false;
      const showCpc = contract ? (contract.showCpcToSponsor ?? contract.showPricingToSponsor ?? false) : false;
      const hasAnyCost = (showCpm || showCpc) && costMetrics;
      const terms = contract ? getTerms(contract) : [];

      // Build static chart SVG
      let chartSvg = "";
      const chartData = buildChartData(runs);
      const totalOpens = runs.reduce((s, r) => s + (r.totalOpens || 0), 0);
      if (chartData.length >= 3) {
        const W = 700, H = 180;
        const pad = { top: 15, right: 15, bottom: 30, left: 15 };
        const maxVal = Math.max(...chartData.map(d => d.total)) || 1;
        const minDate = chartData[0].date.getTime();
        const maxDate = chartData[chartData.length - 1].date.getTime();
        const dateRange = maxDate - minDate || 1;
        const pts = chartData.map(d => ({
          x: pad.left + ((d.date.getTime() - minDate) / dateRange) * (W - pad.left - pad.right),
          y: pad.top + (1 - d.total / maxVal) * (H - pad.top - pad.bottom),
          isSend: d.isSend, date: d.date,
        }));
        const linePath = pts.map((pt, i) => `${i === 0 ? 'M' : 'L'} ${pt.x} ${pt.y}`).join(' ');
        const areaPath = linePath + ` L ${pts[pts.length-1].x} ${H - pad.bottom} L ${pts[0].x} ${H - pad.bottom} Z`;
        const sendPts = pts.filter(pt => pt.isSend);
        const labels = sendPts.map(pt => `<text x="${pt.x}" y="${H - 6}" text-anchor="middle" style="font-size:9px;fill:${P.muted};font-family:${F}">${new Date(pt.date).toLocaleDateString("en-US", { month: "short", day: "numeric" })}</text>`).join('');
        const dots = sendPts.map(pt => `<circle cx="${pt.x}" cy="${pt.y}" r="4" fill="${P.blue}" stroke="${P.bg}" stroke-width="2"/>`).join('');
        chartSvg = `<svg viewBox="0 0 ${W} ${H}" style="width:100%;height:auto;display:block;margin-top:12px">
          <defs><linearGradient id="pg" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="${P.blue}" stop-opacity="0.2"/><stop offset="100%" stop-color="${P.blue}" stop-opacity="0.02"/></linearGradient></defs>
          <path d="${areaPath}" fill="url(#pg)"/><path d="${linePath}" fill="none" stroke="${P.blue}" stroke-width="2" stroke-linejoin="round"/>${dots}${labels}</svg>`;
      }

      // Metric card helper
      const mc = (label, value, color) => `<div style="flex:1;border:1px solid ${P.border};border-radius:10px;padding:16px 12px;text-align:center;background:${P.card}">
        <div style="font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:${P.muted};margin-bottom:8px">${label}</div>
        <div style="font-size:28px;font-weight:700;color:${color};font-family:${F}">${value}</div></div>`;

      // Runs table rows
      const sortedRuns = [...runs].sort((a, b) => new Date(b.sendDate) - new Date(a.sendDate));
      const rows = sortedRuns.map((r, i) => {
        const clicks = getRunClicks(r);
        const ctr = r.totalOpens > 0 ? (clicks / r.totalOpens) * 100 : 0;
        const bg = i % 2 === 0 ? P.bg : P.card;
        return `<tr style="background:${bg}">
          <td style="padding:10px 12px;font-size:12px;color:${P.text};border-bottom:1px solid ${P.border}">${r.emailName}${r.description ? `<br><span style="font-size:11px;color:${P.muted};font-style:italic">${r.description}</span>` : ''}</td>
          <td style="padding:10px 8px;font-size:12px;color:${P.muted};border-bottom:1px solid ${P.border};text-align:center">${fd(r.sendDate)}</td>
          <td style="padding:10px 8px;font-size:13px;font-weight:600;color:${P.blue};border-bottom:1px solid ${P.border};text-align:center">${n(r.totalOpens)}</td>
          <td style="padding:10px 8px;font-size:13px;font-weight:600;color:${P.green};border-bottom:1px solid ${P.border};text-align:center">${n(clicks)}</td>
          <td style="padding:10px 8px;font-size:13px;font-weight:600;color:${P.amber};border-bottom:1px solid ${P.border};text-align:center">${p(ctr)}</td></tr>`;
      }).join('');

      return `<div style="font-family:${F};color:${P.text};max-width:720px;margin:0 auto;padding:8px 0">
        ${config.publicationName ? `<div style="font-size:22px;font-weight:700;text-transform:uppercase;letter-spacing:3px;color:${P.text};margin-bottom:4px">${config.publicationName}</div>` : ''}
        <div style="font-size:13px;color:${P.muted};margin-bottom:16px">Campaign Performance Report</div>
        <hr style="border:none;border-top:1px solid ${P.border};margin:0 0 20px"/>

        <div style="font-size:28px;font-weight:700;color:${P.text};margin-bottom:4px">${sponsor.name}</div>
        ${contract ? `<div style="font-size:13px;color:${P.muted};margin-bottom:2px">${fd(contract.startDate)} â€” ${fd(contract.endDate)}</div>
        <div style="font-size:13px;color:${P.muted};margin-bottom:16px">${runs.length} of ${contract.totalRuns} emails delivered</div>` : `<div style="font-size:13px;color:${P.muted};margin-bottom:16px">${runs.length} email${runs.length !== 1 ? 's' : ''} sent</div>`}

        <div style="display:flex;gap:12px;margin-bottom:${hasAnyCost ? '12px' : '20px'}">
          ${mc("Total Opens", n(totals.opens), P.blue)}
          ${mc("Total Clicks", n(totals.clicks), P.green)}
          ${mc("Click-Through Rate", p(totals.ctr), P.amber)}
        </div>

        ${hasAnyCost ? `<div style="display:flex;gap:12px;margin-bottom:${terms.length > 0 ? '12px' : '20px'}">
          ${showCpm ? mc("CPM", m(costMetrics.cpm), P.purple) : ''}
          ${showCpc ? mc("CPC", m(costMetrics.cpc), P.purple) : ''}
        </div>` : ''}

        ${hasAnyCost && terms.length > 0 ? `<div style="margin-bottom:20px;display:flex;gap:6px;flex-wrap:wrap">${terms.map(t => `<span style="padding:5px 12px;border-radius:16px;background:#F3F0FF;border:1px solid #E0D8F8;color:${P.purple};font-size:11px;font-weight:600">âœ¦ ${t}</span>`).join('')}</div>` : ''}

        <div style="text-align:center;padding:20px 0;margin-bottom:12px;background:${P.card};border:1px solid ${P.border};border-radius:12px">
          <div style="font-size:12px;color:${P.muted};margin-bottom:4px">Seen by</div>
          <div style="font-size:38px;font-weight:700;color:${P.blue};font-family:${F}">${n(totalOpens)}</div>
          <div style="font-size:12px;color:${P.muted}">readers</div>
          ${chartSvg}
        </div>

        <hr style="border:none;border-top:1px solid ${P.border};margin:0 0 16px"/>
        <div style="font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:${P.muted};margin-bottom:12px">Email Breakdown</div>
        <table style="width:100%;border-collapse:collapse;border:1px solid ${P.border};border-radius:8px;overflow:hidden">
          <thead><tr style="background:${P.card}">
            <th style="padding:10px 12px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:${P.muted};text-align:left;border-bottom:1px solid ${P.border}">Email</th>
            <th style="padding:10px 8px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:${P.muted};text-align:center;border-bottom:1px solid ${P.border}">Date</th>
            <th style="padding:10px 8px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:${P.muted};text-align:center;border-bottom:1px solid ${P.border}">Opens</th>
            <th style="padding:10px 8px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:${P.muted};text-align:center;border-bottom:1px solid ${P.border}">Clicks</th>
            <th style="padding:10px 8px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:${P.muted};text-align:center;border-bottom:1px solid ${P.border}">CTR</th>
          </tr></thead>
          <tbody>${rows}</tbody>
        </table>

        <hr style="border:none;border-top:1px solid ${P.border};margin:24px 0 12px"/>
        <div style="text-align:center;font-size:11px;color:${P.muted};line-height:1.8">
          Generated ${new Date().toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" })}
          ${config.publicationName ? `<br>${config.publicationName}${config.publicationUrl ? ` Â· ${config.publicationUrl}` : ''}` : ''}
          <br>Confidential â€” prepared for ${sponsor.name}
        </div>
      </div>`;
    }

    async function downloadReport({ sponsor, contract, runs, totals, costMetrics, config }) {
      const html = buildReportHTML({ sponsor, contract, runs, totals, costMetrics, config });
      const container = document.createElement('div');
      container.innerHTML = html;
      container.style.position = 'absolute';
      container.style.left = '-9999px';
      container.style.top = '0';
      container.style.background = '#FFFFFF';
      document.body.appendChild(container);
      const opt = {
        margin: [0.4, 0.5, 0.4, 0.5],
        filename: `${sponsor.name.replace(/\s+/g, '-')}-Report-${new Date().toISOString().split('T')[0]}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['avoid-all'] },
      };
      await html2pdf().set(opt).from(container).save();
      document.body.removeChild(container);
    }

    function CumulativeChart({ data, onHover }) {
      const containerRef = React.useRef(null);
      const [hoverX, setHoverX] = React.useState(null);
      const [hoverY, setHoverY] = React.useState(null);
      const W = 800, H = 220;
      const pad = { top: 20, right: 20, bottom: 35, left: 20 };
      const maxVal = Math.max(...data.map(d => d.total)) || 1;
      const minDate = data[0].date.getTime();
      const maxDate = data[data.length - 1].date.getTime();
      const dateRange = maxDate - minDate || 1;
      const toX = (date) => pad.left + ((date.getTime() - minDate) / dateRange) * (W - pad.left - pad.right);
      const toY = (val) => pad.top + (1 - val / maxVal) * (H - pad.top - pad.bottom);
      const points = data.map(d => ({ x: toX(d.date), y: toY(d.total), ...d }));
      const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
      const areaPath = linePath + ` L ${points[points.length - 1].x} ${H - pad.bottom} L ${points[0].x} ${H - pad.bottom} Z`;
      const handleMouseMove = (e) => {
        const rect = containerRef.current?.getBoundingClientRect();
        if (!rect) return;
        const mouseXRatio = (e.clientX - rect.left) / rect.width;
        const svgX = mouseXRatio * W;
        let closest = points[0], closestDist = Infinity;
        for (const p of points) { const dist = Math.abs(p.x - svgX); if (dist < closestDist) { closestDist = dist; closest = p; } }
        onHover({ total: closest.total, date: closest.date, isSend: closest.isSend, label: closest.label });
        setHoverX(closest.x);
        setHoverY(closest.y);
      };
      const sendPoints = points.filter(p => p.isSend);
      return (
        <div ref={containerRef} onMouseMove={handleMouseMove} onMouseLeave={() => { onHover(null); setHoverX(null); setHoverY(null); }} style={{ cursor: "crosshair", position: "relative" }}>
          <svg viewBox={`0 0 ${W} ${H}`} style={{ width: "100%", height: "auto", display: "block" }}>
            <defs>
              <linearGradient id="reachGrad" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stopColor="#4F8FF7" stopOpacity="0.3" />
                <stop offset="100%" stopColor="#4F8FF7" stopOpacity="0.02" />
              </linearGradient>
            </defs>
            <path d={areaPath} fill="url(#reachGrad)" />
            <path d={linePath} fill="none" stroke="#4F8FF7" strokeWidth="2.5" strokeLinejoin="round" strokeLinecap="round" />
            {sendPoints.map((p, i) => (
              <circle key={i} cx={p.x} cy={p.y} r="5" fill="#4F8FF7" stroke="#06090F" strokeWidth="2" />
            ))}
            {hoverX !== null && (
              <line x1={hoverX} y1={pad.top} x2={hoverX} y2={H - pad.bottom} stroke="rgba(255,255,255,0.2)" strokeWidth="1" strokeDasharray="4 3" />
            )}
            {hoverX !== null && hoverY !== null && (
              <circle cx={hoverX} cy={hoverY} r="6" fill="#4F8FF7" stroke="#fff" strokeWidth="2" />
            )}
            {sendPoints.map((p, i) => (
              <text key={i} x={p.x} y={H - 8} textAnchor="middle" style={{ fontSize: 10, fill: "#4A5A72", fontFamily: FONT }}>
                {new Date(p.date).toLocaleDateString("en-US", { month: "short", day: "numeric" })}
              </text>
            ))}
          </svg>
        </div>
      );
    }

    function ReachSection({ runs }) {
      const [hoverData, setHoverData] = useState(null);
      const chartData = buildChartData(runs);
      const totalOpens = runs.reduce((s, r) => s + (r.totalOpens || 0), 0);
      const displayTotal = hoverData ? hoverData.total : totalOpens;
      return (
        <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 16, padding: "32px 28px", marginBottom: 32, textAlign: "center" }}>
          <p style={{ fontSize: 13, color: C.dim, marginBottom: 8 }}>Seen by</p>
          <p style={{ fontSize: 52, fontWeight: 700, fontFamily: MONO, color: C.accent, letterSpacing: -2 }}>{num(displayTotal)}</p>
          <p style={{ fontSize: 14, color: C.dim, marginBottom: chartData.length >= 3 ? 24 : 0 }}>
            {hoverData
              ? (hoverData.isSend
                ? `on ${new Date(hoverData.date).toLocaleDateString("en-US", { month: "short", day: "numeric" })} â€” ${hoverData.label}`
                : new Date(hoverData.date).toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" }))
              : "readers"
            }
          </p>
          {chartData.length >= 3 && <CumulativeChart data={chartData} onHover={setHoverData} />}
        </div>
      );
    }

    function MetricCard({ label, value, sub, color }) {
      return (
        <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 14, padding: 24, position: "relative", overflow: "hidden" }}>
          <div style={{ position: "absolute", top: 0, left: 0, right: 0, height: 2, background: `linear-gradient(90deg,${color},transparent)` }} />
          <p style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.5, color: C.dim, marginBottom: 14 }}>{label}</p>
          <p style={{ fontSize: 34, fontWeight: 700, fontFamily: MONO, color, letterSpacing: -1.5 }}>{value}</p>
          {sub && <p style={{ fontSize: 12, color: C.dim, marginTop: 8 }}>{sub}</p>}
        </div>
      );
    }
    function BigStat({ label, value, color, sub }) {
      return (
        <div style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 16, padding: "32px 28px", position: "relative", overflow: "hidden" }}>
          <div style={{ position: "absolute", top: 0, left: 0, width: "100%", height: 3, background: `linear-gradient(90deg,${color}88,${color},${color}88)` }} />
          <p style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 2, color: C.muted, marginBottom: 16 }}>{label}</p>
          <p style={{ fontSize: 40, fontWeight: 700, fontFamily: MONO, color, letterSpacing: -2 }}>{value}</p>
          {sub && <p style={{ fontSize: 12, color: C.dim, marginTop: 10 }}>{sub}</p>}
        </div>
      );
    }
    function NumDisplay({ label, value, color }) {
      return (<div style={{ textAlign: "center" }}><p style={{ fontFamily: MONO, fontSize: 20, fontWeight: 600, color }}>{value}</p><p style={{ fontSize: 10, color: C.dim, textTransform: "uppercase", letterSpacing: 1.2, marginTop: 4 }}>{label}</p></div>);
    }
    function Btn({ children, onClick, color, bg, disabled, small, style: extra = {} }) {
      return <button onClick={onClick} disabled={disabled} style={{ padding: small ? "6px 10px" : "9px 16px", background: bg, color, border: "none", borderRadius: 8, fontFamily: FONT, fontSize: small ? 12 : 13, fontWeight: 600, cursor: disabled ? "not-allowed" : "pointer", opacity: disabled ? 0.5 : 1, whiteSpace: "nowrap", transition: "opacity 0.1s", ...extra }}>{children}</button>;
    }
    function Overlay({ children, onClose }) {
      return (<div onClick={onClose} style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,0.65)", backdropFilter: "blur(6px)", display: "flex", alignItems: "center", justifyContent: "center", zIndex: 200 }}><div onClick={e => e.stopPropagation()} className="fade-in" style={{ background: C.card, border: `1px solid ${C.border}`, borderRadius: 18, padding: 32, width: 460, maxWidth: "92vw", maxHeight: "85vh", overflow: "auto" }}>{children}</div></div>);
    }
    function Input({ label, help, ...props }) {
      return (<div style={{ marginBottom: 16 }}>{label && <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 6 }}>{label}</label>}<input {...props} style={{ width: "100%", padding: "11px 14px", background: C.bg, border: `1px solid ${C.border}`, borderRadius: 10, color: C.text, fontFamily: props.type === "date" || props.type === "password" ? MONO : FONT, fontSize: 14, boxSizing: "border-box", transition: "border-color 0.15s", ...(props.style || {}) }} />{help && <p style={{ fontSize: 11, color: C.dim, margin: "5px 0 0" }}>{help}</p>}</div>);
    }

    // â”€â”€â”€ Forms â”€â”€â”€
    function SettingsForm({ config, onSave, onCancel }) {
      const [ak, setAk] = useState(config.apiKey || "");
      const [pi, setPi] = useState(config.pubId || "");
      const [pn, setPn] = useState(config.publicationName || "");
      const [pu, setPu] = useState(config.publicationUrl || "");
      const [debugData, setDebugData] = useState(null);
      const [debugLoading, setDebugLoading] = useState(false);
      const runDebug = async () => {
        if (!ak.trim() || !pi.trim()) { alert("Enter API key and Pub ID first"); return; }
        setDebugLoading(true);
        try { const res = await fetch("/api/debug", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ apiKey: ak.trim(), pubId: pi.trim() }) }); setDebugData(await res.json()); }
        catch (e) { setDebugData({ error: e.message }); }
        finally { setDebugLoading(false); }
      };
      return (
        <div>
          <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 6 }}>Beehiiv API Settings</h3>
          <p style={{ fontSize: 13, color: C.muted, marginBottom: 24 }}>Connect your Beehiiv account to auto-sync campaign data.</p>
          <Input label="API Key" type="password" value={ak} onChange={e => setAk(e.target.value)} placeholder="Your Beehiiv API key" help="Beehiiv â†’ Settings â†’ Integrations â†’ API â†’ Create New API Key" />
          <Input label="Publication ID" value={pi} onChange={e => setPi(e.target.value)} placeholder="pub_00000000-0000-0000-0000-000000000000" help='The API V2 one starting with "pub_"' />
          <div style={{ marginTop: 16, paddingTop: 16, borderTop: `1px solid ${C.border}` }}>
            <p style={{ fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 12 }}>PDF Report Branding</p>
            <Input label="Publication Name" value={pn} onChange={e => setPn(e.target.value)} placeholder="e.g. The Mommy" help="Used in PDF report header and footer" />
            <Input label="Publication URL" value={pu} onChange={e => setPu(e.target.value)} placeholder="e.g. themommy.news" help="Used in PDF report footer" />
          </div>
          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end", marginTop: 8 }}>
            <Btn onClick={runDebug} color={C.amber} bg={C.amberDim} disabled={debugLoading}>{debugLoading ? "Loading..." : "ğŸ” Test API"}</Btn>
            <Btn onClick={onCancel} color={C.muted} bg="transparent" style={{ border: `1px solid ${C.border}` }}>Cancel</Btn>
            <Btn onClick={() => onSave({ apiKey: ak.trim(), pubId: pi.trim(), publicationName: pn.trim(), publicationUrl: pu.trim() })} color={C.white} bg={C.accent}>Save</Btn>
          </div>
          {debugData && (
            <div style={{ marginTop: 16, padding: 12, background: C.bg, borderRadius: 10, border: `1px solid ${C.border}`, maxHeight: 300, overflow: "auto" }}>
              <p style={{ fontSize: 11, fontWeight: 600, color: C.amber, marginBottom: 8 }}>API Response ({debugData.total_results || 0} total posts, {debugData.total_pages || 0} pages):</p>
              {(debugData.posts || []).map((p, i) => (
                <div key={i} style={{ marginBottom: 12, paddingBottom: 12, borderBottom: `1px solid ${C.border}` }}>
                  <p style={{ fontSize: 12, fontWeight: 600, color: C.text }}>{p.title} <span style={{ color: C.dim, fontWeight: 400 }}>({p.status}, {p.platform})</span></p>
                  <p style={{ fontSize: 11, color: C.muted }}>Opens: {p.email_opens} | Clicks: {p.email_clicks}</p>
                  {p.click_urls.length > 0 ? p.click_urls.map((u, j) => (
                    <p key={j} style={{ fontSize: 10, fontFamily: MONO, color: C.dim, margin: "2px 0", wordBreak: "break-all" }}>{u.total_clicks}x â†’ {u.url || u.base_url}</p>
                  )) : <p style={{ fontSize: 10, color: C.dim }}>No click data</p>}
                </div>
              ))}
              {debugData.error && <p style={{ fontSize: 12, color: C.red }}>{debugData.error}</p>}
            </div>
          )}
        </div>
      );
    }

    function AddSponsorForm({ onSave, onCancel }) {
      const [name, setName] = useState("");
      const [patterns, setPatterns] = useState([""]);

      const updatePat = (i, val) => { const p = [...patterns]; p[i] = val; setPatterns(p); };
      const addPat = () => setPatterns([...patterns, ""]);
      const removePat = (i) => { if (patterns.length <= 1) return; setPatterns(patterns.filter((_, idx) => idx !== i)); };

      return (
        <div>
          <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 24 }}>Add Sponsor</h3>
          <Input label="Sponsor Name" value={name} onChange={e => setName(e.target.value)} placeholder="e.g. Platoon Kids" />

          <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 6 }}>URL Patterns</label>
          {patterns.map((p, i) => (
            <div key={i} style={{ display: "flex", gap: 6, marginBottom: 8 }}>
              <input value={p} onChange={e => updatePat(i, e.target.value)} placeholder={i === 0 ? "e.g. go.themommy.news/kp" : "another pattern..."} style={{ flex: 1, padding: "10px 12px", background: C.bg, border: `1px solid ${C.border}`, borderRadius: 8, color: C.text, fontFamily: MONO, fontSize: 13, outline: "none", boxSizing: "border-box" }} />
              {patterns.length > 1 && <button onClick={() => removePat(i)} style={{ background: C.redDim, color: C.red, border: "none", borderRadius: 8, padding: "0 10px", cursor: "pointer", fontSize: 16, fontWeight: 700 }}>Ã—</button>}
            </div>
          ))}
          <button onClick={addPat} style={{ background: "none", border: `1px dashed ${C.border}`, borderRadius: 8, color: C.dim, padding: "8px 12px", width: "100%", cursor: "pointer", fontFamily: FONT, fontSize: 12, marginBottom: 8 }}>+ Add Another Pattern</button>
          <p style={{ fontSize: 10, color: C.dim, marginBottom: 20 }}>Each pattern matches any click URL containing that text. Use multiple patterns when a sponsor has different link formats across campaigns.</p>

          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <Btn onClick={onCancel} color={C.muted} bg="transparent" style={{ border: `1px solid ${C.border}` }}>Cancel</Btn>
            <Btn onClick={() => name.trim() && onSave(name.trim(), patterns.filter(p => p.trim()))} color={C.white} bg={C.accent} disabled={!name.trim()}>Add</Btn>
          </div>
        </div>
      );
    }

    function ContractForm({ sponsorId, contract, onSave, onCancel }) {
      const [name, setName] = useState(contract?.name || "");
      const [price, setPrice] = useState(contract?.totalPrice ?? "");
      const [totalRuns, setTotalRuns] = useState(contract?.totalRuns ?? "");
      const [startDate, setStartDate] = useState(contract?.startDate || "");
      const [endDate, setEndDate] = useState(contract?.endDate || "");
      const [showCpm, setShowCpm] = useState(contract?.showCpmToSponsor ?? contract?.showPricingToSponsor ?? false);
      const [showCpc, setShowCpc] = useState(contract?.showCpcToSponsor ?? contract?.showPricingToSponsor ?? false);
      const [exclPlace, setExclPlace] = useState(contract?.exclusivePlacement || false);
      const [primPlace, setPrimPlace] = useState(contract?.primaryPlacement || false);
      const [catExcl, setCatExcl] = useState(contract?.categoryExclusivity || false);
      const [pNotes, setPNotes] = useState(contract?.pricingNotes || "");
      const MiniToggle = ({ on, onToggle, label }) => (
        <button onClick={onToggle} style={{
          display: "flex", alignItems: "center", gap: 8, padding: "7px 14px",
          background: on ? C.purpleDim : C.bg, border: `1px solid ${on ? "rgba(167,139,250,0.3)" : C.border}`,
          borderRadius: 8, cursor: "pointer", transition: "all 0.15s", marginBottom: 8,
        }}>
          <div style={{ width: 32, height: 18, borderRadius: 9, padding: 2, background: on ? C.purple : C.dim, transition: "background 0.15s", display: "flex", alignItems: "center" }}>
            <div style={{ width: 14, height: 14, borderRadius: 7, background: "#fff", transform: on ? "translateX(14px)" : "translateX(0)", transition: "transform 0.15s" }} />
          </div>
          <span style={{ fontSize: 12, fontWeight: 600, color: on ? C.purple : C.dim, fontFamily: FONT }}>{label}</span>
        </button>
      );
      return (
        <div>
          <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 24 }}>{contract ? "Edit Contract" : "New Contract"}</h3>
          <Input label="Contract Name" value={name} onChange={e => setName(e.target.value)} placeholder="e.g. Q1 2026" />
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <Input label="Total Price ($)" type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="2500" />
            <Input label="Number of Runs" type="number" value={totalRuns} onChange={e => setTotalRuns(e.target.value)} placeholder="5" />
          </div>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <Input label="Start Date" type="date" value={startDate} onChange={e => setStartDate(e.target.value)} />
            <Input label="End Date" type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
          </div>
          <div style={{ marginBottom: 20 }}>
            <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 8 }}>Sponsor Visibility</label>
            <MiniToggle on={showCpm} onToggle={() => setShowCpm(!showCpm)} label={showCpm ? "CPM visible to sponsor" : "CPM hidden"} />
            <MiniToggle on={showCpc} onToggle={() => setShowCpc(!showCpc)} label={showCpc ? "CPC visible to sponsor" : "CPC hidden"} />
            <p style={{ fontSize: 10, color: C.dim, marginTop: 2 }}>Controls which cost metrics appear in the sponsor view.</p>
          </div>
          <div style={{ marginBottom: 20, paddingTop: 16, borderTop: `1px solid ${C.border}` }}>
            <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 12 }}>Package Terms</label>
            <label style={{ display: "flex", alignItems: "center", gap: 10, cursor: "pointer", marginBottom: 10 }}>
              <input type="checkbox" checked={exclPlace} onChange={e => setExclPlace(e.target.checked)} style={{ width: 16, height: 16, accentColor: C.purple, cursor: "pointer" }} />
              <span style={{ fontSize: 13, color: C.text }}>Exclusive Placement</span>
              <span style={{ fontSize: 11, color: C.dim }}>â€” sole sponsor per issue</span>
            </label>
            <label style={{ display: "flex", alignItems: "center", gap: 10, cursor: "pointer", marginBottom: 10 }}>
              <input type="checkbox" checked={primPlace} onChange={e => setPrimPlace(e.target.checked)} style={{ width: 16, height: 16, accentColor: C.purple, cursor: "pointer" }} />
              <span style={{ fontSize: 13, color: C.text }}>Primary Placement</span>
              <span style={{ fontSize: 11, color: C.dim }}>â€” featured top-of-email placement</span>
            </label>
            <label style={{ display: "flex", alignItems: "center", gap: 10, cursor: "pointer", marginBottom: 12 }}>
              <input type="checkbox" checked={catExcl} onChange={e => setCatExcl(e.target.checked)} style={{ width: 16, height: 16, accentColor: C.purple, cursor: "pointer" }} />
              <span style={{ fontSize: 13, color: C.text }}>Category Exclusivity</span>
              <span style={{ fontSize: 11, color: C.dim }}>â€” no competing brands</span>
            </label>
            <Input label="Other Terms" value={pNotes} onChange={e => setPNotes(e.target.value)} placeholder="e.g. Top-of-email hero placement" />
          </div>
          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <Btn onClick={onCancel} color={C.muted} bg="transparent" style={{ border: `1px solid ${C.border}` }}>Cancel</Btn>
            <Btn onClick={() => name.trim() && onSave({ sponsorId, name: name.trim(), totalPrice: parseFloat(price) || 0, totalRuns: parseInt(totalRuns) || 1, startDate: startDate || null, endDate: endDate || null, showCpmToSponsor: showCpm, showCpcToSponsor: showCpc, exclusivePlacement: exclPlace, primaryPlacement: primPlace, categoryExclusivity: catExcl, pricingNotes: pNotes.trim() })} color={C.white} bg={C.purple} disabled={!name.trim()}>{contract ? "Update" : "Create"}</Btn>
          </div>
        </div>
      );
    }

    function RunForm({ sponsorId, run, contracts, activeContract, onSave, onCancel }) {
      const [en, setEn] = useState(run?.emailName || "");
      const [sd, setSd] = useState(run?.sendDate || new Date().toISOString().split("T")[0]);
      const [op, setOp] = useState(run?.totalOpens ?? "");
      const [cl, setCl] = useState(run?.totalClicks ?? "");
      const [ctId, setCtId] = useState(run?.contractId || (activeContract?.id || ""));
      const [desc, setDesc] = useState(run?.description || "");
      const [note, setNote] = useState(run?.adminNote || "");
      const [useV, setUseV] = useState(run?.useVerified || false);
      return (
        <div>
          <h3 style={{ fontSize: 20, fontWeight: 700, marginBottom: 24 }}>{run ? "Edit Run" : "Add Manual Run"}</h3>
          <Input label="Email Name" value={en} onChange={e => setEn(e.target.value)} placeholder="e.g. Shower Curtain Liner Hack" />
          <Input label="Description" value={desc} onChange={e => setDesc(e.target.value)} placeholder="e.g. Patches + Jacket hero placement" help="Visible to the sponsor in their view" />
          <Input label="Send Date" type="date" value={sd} onChange={e => setSd(e.target.value)} />
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
            <Input label="Total Opens" type="number" value={op} onChange={e => setOp(e.target.value)} placeholder="25832" />
            <Input label="Total Clicks" type="number" value={cl} onChange={e => setCl(e.target.value)} placeholder="474" help="Sum all sponsor links" />
          </div>
          {contracts && contracts.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 6 }}>Contract</label>
              <select value={ctId} onChange={e => setCtId(e.target.value)} style={{ width: "100%", padding: "11px 14px", background: C.bg, border: `1px solid ${C.border}`, borderRadius: 10, color: C.text, fontFamily: FONT, fontSize: 14, boxSizing: "border-box" }}>
                <option value="">Unassigned</option>
                {contracts.map(c => <option key={c.id} value={c.id}>{c.name}{c.isActive ? " (Active)" : ""}</option>)}
              </select>
            </div>
          )}
          <div style={{ marginBottom: 16 }}>
            <button onClick={() => setUseV(!useV)} style={{
              display: "flex", alignItems: "center", gap: 8, padding: "7px 14px",
              background: useV ? C.greenDim : C.bg, border: `1px solid ${useV ? "rgba(52,211,153,0.3)" : C.border}`,
              borderRadius: 8, cursor: "pointer", transition: "all 0.15s",
            }}>
              <div style={{ width: 32, height: 18, borderRadius: 9, padding: 2, background: useV ? C.green : C.dim, transition: "background 0.15s", display: "flex", alignItems: "center" }}>
                <div style={{ width: 14, height: 14, borderRadius: 7, background: "#fff", transform: useV ? "translateX(14px)" : "translateX(0)", transition: "transform 0.15s" }} />
              </div>
              <span style={{ fontSize: 12, fontWeight: 600, color: useV ? C.green : C.dim, fontFamily: FONT }}>Use Verified Clicks</span>
            </button>
            <p style={{ fontSize: 11, color: C.dim, margin: "5px 0 0" }}>Report verified (bot-filtered) clicks for this run</p>
          </div>
          <div style={{ marginBottom: 16 }}>
            <label style={{ display: "block", fontSize: 11, fontWeight: 600, textTransform: "uppercase", letterSpacing: 1.2, color: C.muted, marginBottom: 6 }}>Admin Note</label>
            <textarea value={note} onChange={e => setNote(e.target.value)} placeholder="Internal only â€” sponsor won't see this" rows={3} style={{ width: "100%", padding: "11px 14px", background: C.bg, border: `1px solid ${C.border}`, borderLeft: `3px solid ${C.amber}`, borderRadius: 10, color: C.text, fontFamily: FONT, fontSize: 14, boxSizing: "border-box", resize: "vertical", outline: "none" }} />
            <p style={{ fontSize: 11, color: C.dim, margin: "5px 0 0" }}>Private note â€” only visible in admin view</p>
          </div>
          <div style={{ display: "flex", gap: 8, justifyContent: "flex-end" }}>
            <Btn onClick={onCancel} color={C.muted} bg="transparent" style={{ border: `1px solid ${C.border}` }}>Cancel</Btn>
            <Btn onClick={() => onSave({ sponsorId, emailName: en.trim() || "Untitled", sendDate: sd, totalOpens: parseInt(op) || 0, totalClicks: parseInt(cl) || 0, contractId: ctId || null, description: desc.trim(), adminNote: note.trim(), useVerified: useV, autoSynced: false })} color={C.white} bg={C.green}>{run ? "Update" : "Save"}</Btn>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>

</html>